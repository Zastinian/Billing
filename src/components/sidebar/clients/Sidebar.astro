---
interface Props {
  route: string;
}

const { route } = Astro.props;

import { settings, servers, clients } from "@/database/index";
import profile from "@/utils/profile";
import { serverStatus } from "@/utils/status";
import type { Clients } from "@/database/entities/Clients";

const cookie: string = `${Astro.cookies.get("_SECURE_SESSION_TOKEN_")?.value}`;
const c = profile(cookie);

let client: Clients | null = null;
if (c.success === true && c.clientId !== null) {
  client = await clients.findOneBy({ id: c.clientId });
}

const panelUrl = await settings.findOneBy({ key: "panel_url" }).then((setting) => setting?.value);
const phpMyAdminUrl = await settings
  .findOneBy({ key: "phpmyadmin_url" })
  .then((setting) => setting?.value);
const companyName = await settings
  .findOneBy({ key: "company_name" })
  .then((setting) => setting?.value);
const logoPath = await settings.findOneBy({ key: "logo_path" }).then((setting) => setting?.value);
const clientServers = await servers.findBy({ clientId: client?.id });
---

<aside class="main-sidebar sidebar-dark-primary elevation-4">
    <a href="/client" class="brand-link">
        <img src={logoPath} alt={`${companyName} Logo`} class="brand-image" />
        <span class="brand-text font-weight-light">{companyName}</span>
    </a>
    <div class="sidebar">
        <div class="form-inline">
            <div class="input-group" data-widget="sidebar-search">
                <input class="form-control form-control-sidebar" type="search" placeholder="Search" aria-label="Search" />
                <div class="input-group-append">
                    <button class="btn btn-sidebar">
                        <i class="fas fa-search fa-fw"></i>
                    </button>
                </div>
            </div>
        </div>
        <nav class="mt-2" id="sidebar-menu">
            <ul class="nav nav-pills nav-sidebar flex-column nav-legacy nav-flat" data-widget="treeview" role="menu" data-accordion="false">
                <li class="nav-item">
                    <a href="/client" class={`nav-link ${route === "client.dash" ? "active" : ""}`}>
                        <i class="nav-icon fas fa-tachometer-alt"></i>
                        <p>Dashboard</p>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/client/servers" class={`nav-link ${route === "client.servers" ? "active" : ""}`}>
                        <i class="fas fa-server nav-icon"></i>
                        <p>My Servers</p>
                    </a>
                </li>
                {
                    panelUrl && (
                        <li class="nav-item">
                            <a href={panelUrl} class="nav-link" target="_blank">
                        <i class="fas fa-columns nav-icon"></i>
                        <p>Pterodactyl Panel</p>
                            </a>
                        </li>
                    )
                }
                {
                    phpMyAdminUrl && (
                        <li class="nav-item">
                            <a href={phpMyAdminUrl} class="nav-link" target="_blank">
                                <i class="fas fa-tools nav-icon"></i>
                                <p>phpMyAdmin</p>
                            </a>
                        </li>
                    )
                }
                {clientServers.filter((server) => server.status === serverStatus.active).length > 0 && (
                    <li class="nav-header">ACTIVE SERVERS</li>
                )}
                <!-- Start of Servers -->
                 {
                    clientServers.filter((server) => server.status === serverStatus.active).map((server) => (
                        <li class="nav-item">
                            <a href="javascript:void(0);" class="nav-link">
                                <i class="fas fa-server nav-icon"></i>
                                <p>{server.serverName}</p>
                            </a>
                            <ul class="nav nav-treeview">
                                <li class="nav-item">
                                    <a href={`/client/servers/${server.id}`} class="nav-link">
                                        <i class="fas fa-info-circle nav-icon"></i>
                                        <p>Server Info</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href={`/client/servers/${server.id}/plan`} class="nav-link">
                                        <i class="fas fa-scroll nav-icon"></i>
                                        <p>Manage Plan</p>
                                    </a>
                                </li>
                            </ul>
                        </li>
                    ))
                 }
                <!-- End of Servers -->
                <li class="nav-header">BILLING</li>
                <li class="nav-item">
                    <a href="/client/invoices" class={`nav-link ${route === "client.invoices" ? "active" : ""}`}>
                        <i class="nav-icon fas fa-file-invoice-dollar"></i>
                        <p>Invoices</p>
                    </a>
                </li>
                <li class="nav-header">SUPPORT CENTER</li>
                <li class="nav-item">
                    <a href="/client/tickets" class={`nav-link ${route === "client.tickets" ? "active" : ""}`}>
                        <i class="fas fa-ticket-alt nav-icon"></i>
                        <p>Support Tickets</p>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/kb" class="nav-link">
                        <i class="fas fa-book nav-icon"></i>
                        <p>Knowledge Base</p>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/status" class="nav-link">
                        <i class="fas fa-network-wired nav-icon"></i>
                        <p>System Status</p>
                    </a>
                </li>
                <li class="nav-header">ACCOUNT</li>
                <li class="nav-item">
                    <a href="/client/credits" class={`nav-link ${route === "client.credits" ? "active" : ""}`}>
                        <i class="fas fa-money-bill-wave nav-icon"></i>
                        <p>Account Credit</p>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/client/settings" class={`nav-link ${route === "client.settings" ? "active" : ""}`}>
                        <i class="fas fa-cog nav-icon"></i>
                        <p>Account Settings</p>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</aside>
