---
import { clients, currencies, settings } from "@/database/index";
import profile from "@/utils/profile";
import type { Clients as ClientsType } from "@/database/entities/Clients";
import convertCurrency from "@/utils/convertCurrency";
import type { Currencies } from "@/database/entities/Currencies";

const cookie: string = `${Astro.cookies.get("_SECURE_SESSION_TOKEN_")?.value}`;
const c = profile(cookie);

let client: ClientsType | null = null;
if (c.success === true && c.clientId !== null) {
  client = await clients.findOneBy({ id: c.clientId });
}

const clientsData = await clients.find({
  order: { createdAt: "ASC" },
  select: ["id", "userId", "email", "isVerified", "isAdmin", "credit", "createdAt", "updatedAt"],
});
const clientCurrency = await currencies.findOneBy({ id: client?.currency });
const defaultCurrency = await currencies.findOneBy({ id: 1 });
const panelUrl = await settings.findOneBy({ key: "panel_url" }).then((panelUrl) => panelUrl?.value);
---

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <div class="card-tools">
                    <form action="" method="POST">
                        <button type="submit" class="btn btn-success btn-sm">One-click Import Pterodactyl Users <i
                                class="fas fa-plus-circle"></i></button>
                    </form>
                </div>
            </div>
            <div class="card-body table-responsive">
                <table id="clients-table" class="table table-hover text-nowrap">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Panel ID</th>
                            <th>Email</th>
                            <th>Verified</th>
                            <th>Admin</th>
                            <th>Credit</th>
                            <th>Registration Date</th>
                            <th>Updated Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {
                            clientsData.map((client) => (
                                <tr>
                                    <td><a href={`/admin/clients/${client.id}`}>{client.id}</a></td>
                                    <td><a href={new URL(`/admin/users/view/${client.userId}`, panelUrl ?? "").toString()}
                                            target="_blank">{client.userId}</a></td>
                                    <td>{client.email}</td>
                                    <td>
                                        {client.isVerified === 1 ? <><i class="fas fa-check" style="margin-right: 5px;"></i>Yes</> : <><i class="fas fa-times" style="margin-right: 5px;"></i>No</>}
                                    </td>
                                    <td>
                                        {client.isAdmin === 1 ? <><i class="fas fa-check" style="margin-right: 5px;"></i>Yes</> : <><i class="fas fa-times" style="margin-right: 5px;"></i>No</>}
                                    </td>
                                    <td>{clientCurrency?.symbol}{convertCurrency(client.credit, defaultCurrency as Currencies, clientCurrency as Currencies)} {clientCurrency?.name}</td>
                                    <td>{client.createdAt?.toLocaleDateString()} - {client.createdAt?.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', hour12: false })}</td>
                                    <td>{client.updatedAt?.toLocaleDateString()} - {client.updatedAt?.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', hour12: false })}</td>
                                </tr>
                            ))
                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <th>ID</th>
                            <th>Panel ID</th>
                            <th>Email</th>
                            <th>Verified</th>
                            <th>Admin</th>
                            <th>Credit</th>
                            <th>Registration Date</th>
                            <th>Updated Date</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<script is:inline> lazyLoadCss('/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css'); </script>

<script src="/plugins/datatables/jquery.dataTables.min.js" is:inline></script>
<script src="/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js" is:inline></script>

<script is:inline>
    $(function () {
        $("#clients-table").DataTable({ "responsive": false, "lengthChange": false, "autoWidth": false });
    });
</script>
