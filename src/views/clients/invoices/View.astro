---
import { clients, currencies, plans, servers, settings } from "@/database/index";
import profile from "@/utils/profile";
import type { Clients } from "@/database/entities/Clients";
import type { Invoices } from "@/database/entities/Invoices";
import type { Currencies } from "@/database/entities/Currencies";
import convertCurrency from "@/utils/convertCurrency";
import { invoiceStatus, invoiceStatusName } from "@/utils/status";

interface Props {
  invoice: Invoices;
}

const cookie: string = `${Astro.cookies.get("_SECURE_SESSION_TOKEN_")?.value}`;
const c = profile(cookie);

let client: Clients | null = null;
if (c.success === true && c.clientId !== null) {
  client = await clients.findOneBy({ id: c.clientId });
}

const { invoice } = Astro.props;

const companyName = await settings
  .findOneBy({ key: "company_name" })
  .then((setting) => setting?.value);
const logoPath = await settings.findOneBy({ key: "logo_path" }).then((setting) => setting?.value);
const server = invoice.serverId ? await servers.findOneBy({ id: invoice.serverId }) : undefined;
const serverPlan = server ? await plans.findOneBy({ id: server.planId }) : undefined;
const clientCurrency = await currencies.findOneBy({ id: client?.currency });
const defaultCurrency = await currencies.findOneBy({ id: 1 });
---

<div class="row" id="invoice_content">
    <div class="col-12">
        <div class="invoice p-3 mb-3">
            <div class="row">
                <div class="col-12">
                    <h4>
                        <img src={logoPath} height="50px" alt="Logo" /> {companyName}
                        <span class="float-right"> Status: {invoiceStatusName[invoice?.paid ?? invoiceStatus.pending]} </span>
                    </h4>
                </div>
            </div>
            <div class="row invoice-info">
                <div class="col-sm-4 invoice-col">
                    From
                    <address>
                        <strong>{companyName}</strong>
                    </address>
                </div>
                <div class="col-sm-4 invoice-col">
                    To
                    <address>
                        <strong>{client?.email}</strong>
                    </address>
                </div>
                <div class="col-sm-4 invoice-col">
                    <b>Product:</b> Credits
                    <br />
                    <b>Invoice Date:</b> {invoice.createdAt?.toLocaleDateString()} - {invoice.createdAt?.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', hour12: false })}<br />
                </div>
            </div>
            <div class="row">
                <div class="col-12 table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th style="width:85%">Product</th>
                                <th style="width:15%">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>{serverPlan ? serverPlan.name : "Credits"}</td>
                                <td>{clientCurrency?.symbol}{convertCurrency(invoice.total, defaultCurrency as Currencies, clientCurrency as Currencies)} {clientCurrency?.name}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row justify-content-center">
                <div class="col-5">
                    <p class="lead">Payment Methods</p>

                    <div class="table-responsive">
                        <table class="table">
                            <tr>
                                <th style="width:35%">Primary</th>
                                <td>{invoice.paymentMethod}</td>
                            </tr>
                            <tr>
                                <th>Backup</th>
                                <td>Account Credit</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="col-5 offset-1">
                    <p class="lead">Amount Due</p>

                    <div class="table-responsive">
                        <table class="table">
                            <tr>
                                <th>Total Due</th>
                                <td>{clientCurrency?.symbol}{convertCurrency(invoice.total, defaultCurrency as Currencies, clientCurrency as Currencies)} {clientCurrency?.name}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="row no-print">
                <div class="col-12">
                    <button onclick="pay_invoice('{{ $invoice_data }}')" class="btn btn-success float-right">
                        <i class="far fa-credit-card"></i> Pay Now
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
